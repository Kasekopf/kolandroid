package com.github.kolandroid.kol.model.models.inventory;

import com.github.kolandroid.kol.connection.ServerReply;
import com.github.kolandroid.kol.connection.Session;
import com.github.kolandroid.kol.model.GroupModel;
import com.github.kolandroid.kol.util.Logger;
import com.github.kolandroid.kol.util.Regex;
import com.github.kolandroid.kol.util.StringUtils;

import java.util.ArrayList;
import java.util.Map;

public class ItemStorageModel extends GroupModel<ItemPocketModel> {
    /**
     * Autogenerated by eclipse.
     */
    private static final long serialVersionUID = 34637430160L;

    private static final Regex HEADER_TABS = new Regex("<center>\\[.*?</center>", 0);

    private static final Regex TAB = new Regex("\\[(.*?)\\]( |&nbsp;|</center>)", 1);
    private static final Regex TAB_NAME = new Regex("(<[^>]*>)?([^<>]*)(<[^>]*>)?", 2);
    private static final Regex TAB_LINK = new Regex("<a[^>]*href ?= ?[\"']?([^\"'>]*)[\"'>]", 1);

    // inventory.php, closet.php, and storage.php all have a $.get of this form
    //  If this is ever applied to any other pages, this should be revisited
    private static final Regex THIS_TAB_LINK = new Regex("\\$\\.get\\('[^']*(which=[^&']+)[&']", 1);

    private final String baseUrl;

    private final ItemPocketModel[] pockets;

    public ItemStorageModel(Session s, ServerReply text, String baseUrl, boolean useEquipmentModel) {
        super(s);

        this.baseUrl = baseUrl;

        ArrayList<ItemPocketModel> foundPockets = new ArrayList<ItemPocketModel>();
        String tabs = HEADER_TABS.extractSingle(text.html, "");
        if (tabs.isEmpty()) {
            Logger.log("ItemStorageModel", "Unable to find tabs");

            foundPockets.add(new ItemPocketModel("Consume", s, baseUrl + "?which=1"));
            if (useEquipmentModel) {
                foundPockets.add(new EquipmentPocketModel("Equip", s, baseUrl + "?which=2"));
            } else {
                foundPockets.add(new ItemPocketModel("Equip", s, baseUrl + "?which=2"));
            }

            foundPockets.add(new ItemPocketModel("Misc", s, baseUrl + "?which=3"));
            foundPockets.add(new ItemPocketModel("Recent", s, baseUrl + "?which=f-1"));
        } else {
            Logger.log("ItemStorageModel", "Found tabs: " + tabs);
            String thisTab = THIS_TAB_LINK.extractSingle(text.html, "");
            if (thisTab.isEmpty()) {
                Logger.log("ItemStorageModel", "Unable to determine current tab");
                thisTab = text.url;
            } else {
                thisTab = baseUrl + "?" + thisTab;
            }

            for (String tab : TAB.extractAllSingle(tabs)) {
                String name = TAB_NAME.extractSingle(tab, "");
                String url = TAB_LINK.extractSingle(tab, thisTab); //default to the page we are loading

                if (name.equals("+")) continue;
                else if (name.equalsIgnoreCase("consumables")) name = "Consume";
                else if (name.equalsIgnoreCase("equipment")) name = "Equip";
                else if (name.equalsIgnoreCase("miscellaneous")) name = "Misc";
                else if (name.equalsIgnoreCase("recent items")) name = "Recent";

                name = StringUtils.htmlDecode(name);
                Logger.log("ItemStorageModel", "Found tab: " + name + ", " + url);

                if (useEquipmentModel && name.equalsIgnoreCase("equip")) {
                    foundPockets.add(new EquipmentPocketModel(name, s, url));
                } else {
                    foundPockets.add(new ItemPocketModel(name, s, url));
                }
            }
        }

        pockets = foundPockets.toArray(new ItemPocketModel[foundPockets.size()]);

        loadContent(text);
    }

    protected void loadContent(ServerReply text) {
        if (!text.url.contains(baseUrl)) {
            Logger.log("ItemStorageModel", "Attempted to load non-" + baseUrl + " page into ItemStorageModel: "
                    + text.url);
            return;
        }

        ArrayList<String> tabs = TAB.extractAllSingle(HEADER_TABS.extractSingle(text.html, ""));
        for (int i = 0; i < tabs.size(); i++) {
            if (TAB_LINK.extractSingle(tabs.get(i), null) == null) {
                //No link found to go to this tab; we must be IN this tab
                ItemPocketModel[] children = this.getChildren();
                if (i >= children.length) {
                    Logger.log("ItemStorageModel", "Unable to find child " + TAB_NAME.extractSingle(tabs.get(i), "[?]") + "; this model has only " + children.length + " children");
                } else {
                    children[i].process(text);
                    Logger.log("ItemStorageModel", "Loaded " + TAB_NAME.extractSingle(tabs.get(i), "[?]") + " into " + children[i].getTitle());
                    this.setActiveChild(i);
                }
                return;
            }
        }

    }

    public void apply(InventoryUpdateModel update) {
        boolean requireRefresh = false;

        Map<String, Integer> updates = update.getUpdates();
        for (String key : updates.keySet()) {
            boolean found = false;
            for (ItemPocketModel model : getChildren()) {
                if (model.apply(key, updates.get(key))) {
                    found = true;
                }
            }

            if (!found && updates.get(key) > 0) {
                // We have gained a new type of item; we have to fully refresh the page to figure out what it is
                // TODO: implement $.get('inventory.php?ajax=1&which=' + whichpage + '&onlyitem=' + iid, addNewItem);
                Logger.log("ItemStorageModel", "Unable to find item " + key + " to update");
                requireRefresh = true;
            }
        }

        if (requireRefresh) {
            for (ItemPocketModel model : getChildren()) {
                model.refreshIfLoaded();
            }
        }
    }

    @Override
    public ItemPocketModel[] getChildren() {
        return pockets;
    }
}
